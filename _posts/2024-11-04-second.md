# -*- coding: utf-8 -*-
"""Search-Grounding_tutorial_by_PARK_JOON.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1X4_1wHpzqXcZ1-RrhH8hYVASLwd0KEw_

# [Made by PARK JOON](https://bio.link/joonpark)

---
# [Gemini API 발급 방법](https://llm-project-joon.site/API_KEY_%E1%84%87%E1%85%A1%E1%86%AF%E1%84%80%E1%85%B3%E1%86%B8_%E1%84%87%E1%85%A1%E1%86%BC%E1%84%87%E1%85%A5%E1%86%B8)

---
# 필요한 라이브러리 설치
"""

!pip install -U google-generativeai>=0.8.3

"""# API KEY 설정

요금제가 유료로 설정되어있는 API KEY만 search-grounding 기능이 활성화가 됨.  ➡️   [이미지 참고](https://i.ibb.co/sP6cQKn/f954c8e4e818.png)  |  [링크 참고](https://ai.google.dev/pricing#1_5flash)
"""

import google.generativeai as genai
from IPython.display import Markdown, HTML

from google.colab import userdata
GEMINI_API_KEY=userdata.get('GEMINI_API_KEY')
genai.configure(api_key=GEMINI_API_KEY)

"""#### 참고 이미지

[코랩 환경 변수 설정 참고 이미지](https://i.imghippo.com/files/nkS8F1729430186.png)

⚠️ 참고 이미지에서는 OpenAI API KEY를 예시로 들어 설명하고 있습니다.

2️⃣의 "OPENAI_API_KEY" 를 "GEMINI_API_KEY" 로 변경해주세요.

# 튜토리얼

- `GoogleSearchRetrieval`은 Google이 제공하는 공개 웹 데이터를 검색하기 위한 도구

- 주요 기능:
 - `GoogleSearchRetrieval`의 동적 검색 검색을 통해 실시간 데이터로 질의 답변을 생성함

- 사용 방법:
 - `GoogleSearchRetrieval`에 문자열 또는 딕셔너리를 필드에 전달함
 - `generate_content`의 `tools` 매개변수에 `google_search_retrieval`을 전달함
"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')
user_input = input("메시지를 입력하세요: ")

response = model.generate_content(contents=user_input,
                                  tools='google_search_retrieval')


print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""---

이번엔 Gemini API를 통해 수집된 렌더링된 HTML 콘텐츠를 살펴볼 것.

> 중요: 검색 그라운딩 사용 시 다음의 [요구사항](https://googledevai.devsite.corp.google.com/gemini-api/docs/grounding/search-suggestions?hl=en#requirements)을 **반드시** 준수해야 함:

- 검색 제안을 제공된 그대로 표시해야 함
- 사용자가 검색 제안과 상호작용할 때 Google 검색결과 페이지(SRP)로 직접 이동시켜야 함
"""

HTML(response.candidates[0].grounding_metadata.search_entry_point.rendered_content)

"""또한 검색 쿼리에 사용된 소스로 연결되는 링크를 받게 될 것."""

response.candidates[0].grounding_metadata.grounding_chunks

"""그리고 어떤 부분이 어떤 소스에서 인용되었는지 보여주는 참조 구간도 제공받게 될 것."""

grounding_supports = response.candidates[0].grounding_metadata.grounding_supports

import re
import codecs

for i, grounding_support in enumerate(grounding_supports):
    # 객체를 문자열로 변환
    grounding_support_str = str(grounding_support)
    print(f"=== Sequence {i+1} ===")

    # start_index 추출
    start_index = re.search(r'start_index: (\d+)', grounding_support_str)
    print("start_index:", start_index.group(1))

    # end_index 추출
    end_index = re.search(r'end_index: (\d+)', grounding_support_str)
    print("end_index:", end_index.group(1))

    # text 추출
    match = re.search(r'text: "(.*?)"', grounding_support_str)
    text = match.group(1)
    # 이스케이프된 시퀀스를 디코딩
    decoded_text = codecs.escape_decode(text)[0].decode('utf-8')
    print("text:", decoded_text)

    # grounding_chunk_indices 추출 및 형식 변경
    grounding_indices = re.findall(r'grounding_chunk_indices: (\d+)', grounding_support_str)
    grounding_indices_str = ', '.join(grounding_indices)
    print("grounding_chunk_indices:", grounding_indices_str)

    # confidence_scores 추출 및 형식 변경
    confidence = re.findall(r'confidence_scores: (\d+\.\d+)', grounding_support_str)
    confidence_str = ', '.join(confidence)
    print("confidence_scores:", confidence_str)
    print()

"""### search grounding parameter 사용자 정의

딕셔너리 구현의 경우, `mode` 또는 `dynamic_threshold` 키-값 쌍을 전달할 필요가 없음. 값을 전달하지 않으면 기본값이 생성됨. 다음 코드 셀에서 이를 확인할 수 있음. `mode` 값에는 다음 두 가지 사양 중 하나를 전달할 수 있음:

1. `unspecified`: 항상 검색을 실행함
2. `dynamic`: 시스템이 필요하다고 판단할 때만 검색을 실행함

`dynamic_threshold`는 반환된 답변의 관련성을 결정하는 임계값 역할을 하는 float 값임. 답변의 변동 폭을 원하는 정도에 따라 이 매개변수를 조정할 수 있음

- mode : "unspecified"
- dynamic_threshold : 0.5
"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')

user_input = input("메시지를 입력하세요: ")

response = model.generate_content(
    contents=user_input,
    tools={
        "google_search_retrieval": {
            "dynamic_retrieval_config": {
                "mode": "unspecified",
                "dynamic_threshold": 0.5
            }
        }
    }
)

print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""- mode : "unspecified"
"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')

user_input = input("메시지를 입력하세요: ")

response = model.generate_content(
    contents=user_input,
    tools={
        "google_search_retrieval": {
            "dynamic_retrieval_config": {
                "mode": "unspecified"
            }
        }
    }
)

print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""- mode : "dynamic"
- dynamic_threshold : 0.5
"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')

user_input = input("메시지를 입력하세요: ")

response = model.generate_content(
    contents=user_input,
    tools={
        "google_search_retrieval": {
            "dynamic_retrieval_config": {
                "mode": "dynamic",
                "dynamic_threshold": 0.5
            }
        }
    }
)

print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""- mode : "dynamic"
"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')

user_input = input("메시지를 입력하세요: ")

response = model.generate_content(
    contents=user_input,
    tools={
        "google_search_retrieval": {
            "dynamic_retrieval_config": {
                "mode": "dynamic"
            }
        }
    }
)

print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""- dynamic_threshold : 0.5"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')

user_input = input("메시지를 입력하세요: ")

response = model.generate_content(
    contents=user_input,
    tools={
        "google_search_retrieval": {
            "dynamic_retrieval_config": {
                "dynamic_threshold": 0.5
            }
        }
    }
)

print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""빈 딕셔너리를 전달할 수도 있음. 이 경우 `mode`와 `dynamic_threshold`에 대한 기본값이 사용될 것임"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')

user_input = input("메시지를 입력하세요: ")

response = model.generate_content(
    contents=user_input,
    tools={
        "google_search_retrieval": {
            "dynamic_retrieval_config": {}
        }
    }
)

print("\nGemini 답변: \n")
Markdown(response.candidates[0].content.parts[0].text)

"""## With chat

`google_search_retrieval` 도구를 모델에 연결하면 채팅의 모든 턴에서 사용할 수 있음
"""

model = genai.GenerativeModel('models/gemini-1.5-pro-002', tools="google_search_retrieval")
chat = model.start_chat()
user_input = input("메시지를 입력하세요: ")
result = chat.send_message(user_input)

display(Markdown(result.text))

display(HTML(result.candidates[0].grounding_metadata.search_entry_point.rendered_content))

user_input = input("메시지를 입력하세요: ")
result = chat.send_message(user_input)

display(Markdown(result.text))

display(HTML(result.candidates[0].grounding_metadata.search_entry_point.rendered_content))

"""`send_message` 호출을 통해 도구를 전달할 수도 있음."""

model = genai.GenerativeModel('models/gemini-1.5-pro-002')
chat = model.start_chat()

user_input = input("메시지를 입력하세요: ")

result = chat.send_message(user_input, tools="google_search_retrieval")

display(Markdown(result.text))

display(HTML(result.candidates[0].grounding_metadata.search_entry_point.rendered_content))